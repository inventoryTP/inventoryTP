import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
import pandas as pd
import json

# --- 1. р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╣Бр╕ер╕░р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е ---
def get_data(spreadsheet_name, sheet_name):
    try:
        scope = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
        info = json.loads(st.secrets["gcp_service_account"]["json_data"])
        creds = Credentials.from_service_account_info(info, scopes=scope)
        gc = gspread.authorize(creds)
        sh = gc.open(spreadsheet_name)
        worksheet = sh.worksheet(sheet_name)
        df = pd.DataFrame(worksheet.get_all_records())
        return df
    except Exception as e:
        st.error(f"р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▓р╕Б {spreadsheet_name} > {sheet_name} р╣Др╕Фр╣Й: {e}")
        return pd.DataFrame()

# --- 2. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ ---
st.set_page_config(page_title="TP2025 Dashboard", layout="wide")
st.sidebar.title("ЁЯЪА р╣Ар╕бр╕Щр╕╣р╕лр╕ер╕▒р╕Б")
page = st.sidebar.radio("р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Ир╕░р╕Фр╕╣:", ["ЁЯУК р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕вр╕нр╕Фр╕Вр╕▓р╕в (р╕Чр╕╡р╕Юр╕╡2025)", "ЁЯУж р╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н"])

# --- р╕лр╕Щр╣Йр╕▓р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕вр╕нр╕Фр╕Вр╕▓р╕в ---
if page == "ЁЯУК р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕вр╕нр╕Фр╕Вр╕▓р╕в (р╕Чр╕╡р╕Юр╕╡2025)":
    st.title("ЁЯУК р╕кр╕гр╕╕р╕Ыр╕гр╕▓р╕вр╕Зр╕▓р╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕в (р╕Кр╕╡р╕Х: р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕вр╕нр╕Фр╕Вр╕▓р╕в)")
    df = get_data("р╕Чр╕╡р╕Юр╕╡2025", "р╣Бр╕Ыр╕ер╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕вр╕нр╕Фр╕Вр╕▓р╕в")

    if not df.empty:
        # р╕Юр╕вр╕▓р╕вр╕▓р╕бр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Кр╕╖р╣Ир╕нр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╣Йр╕Хр╕гр╕З (р╣Ар╕Ьр╕╖р╣Ир╕нр╕бр╕╡р╣Ар╕зр╣Йр╕Щр╕зр╕гр╕гр╕Д)
        df.columns = [c.strip() for c in df.columns]

        # 1. р╣Бр╕кр╕Фр╕Зр╕вр╕нр╕Фр╕кр╕гр╕╕р╕Ыр╕Фр╣Йр╕▓р╕Щр╕Ър╕Щр╕кр╕╕р╕Ф
        col1, col2 = st.columns(2)
        total_items = len(df)
        total_sales = df['р╕гр╕зр╕бр╣Ар╕Зр╕┤р╕Щ'].sum()
        with col1:
            st.metric("ЁЯУж р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф", f"{total_items:,} р╕гр╕▓р╕вр╕Бр╕▓р╕г")
        with col2:
            st.metric("ЁЯТ░ р╕вр╕нр╕Фр╕Вр╕▓р╕вр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф", f"{total_sales:,.2f} р╕Ър╕▓р╕Ч")

        # 2. р╕Бр╕гр╕▓р╕Яр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕▓р╕вр╣Др╕Фр╣Йр╕кр╕╣р╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф (Group by р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓)
        st.subheader("ЁЯПЖ р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╕гр╕▓р╕вр╣Др╕Фр╣Йр╕кр╕╣р╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф (р╣Бр╕Ър╣Ир╕Зр╕Хр╕▓р╕бр╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓)")
        chart_data = df.groupby('р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓')['р╕гр╕зр╕бр╣Ар╕Зр╕┤р╕Щ'].sum().sort_values(ascending=False).head(10)
        st.bar_chart(chart_data)

        # 3. р╕Хр╕▓р╕гр╕▓р╕Зр╕гр╕зр╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Хр╕▓р╕бр╕гр╕лр╕▒р╕к (р╕гр╕зр╕бр╕Ир╕│р╕Щр╕зр╕Щ р╣Бр╕ер╕░ р╕гр╕зр╕бр╣Ар╕Зр╕┤р╕Щ) р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н
        st.subheader("ЁЯУЭ р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕гр╕╕р╕Ыр╕кр╕┤р╕Щр╕Др╣Йр╕▓ (р╣Ар╕гр╕╡р╕вр╕Зр╕Хр╕▓р╕бр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╕бр╕▓р╕Бр╣Др╕Ыр╕Щр╣Йр╕нр╕в)")
        summary_df = df.groupby(['р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓', 'р╕Кр╕╖р╣Ир╕нр╕кр╕┤р╕Щр╕Др╣Йр╕▓']).agg({
            'р╕Ир╕│р╕Щр╕зр╕Щ': 'sum',
            'р╕гр╕зр╕бр╣Ар╕Зр╕┤р╕Щ': 'sum'
        }).reset_index().sort_values(by='р╕Ир╕│р╕Щр╕зр╕Щ', ascending=False)
        st.dataframe(summary_df, use_container_width=True)

        # 4. р╕Хр╕▓р╕гр╕▓р╕Зр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╕бр╕▓р╕Бр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф
        st.subheader("ЁЯУЕ р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╕вр╕нр╕Фр╕Бр╕▓р╕гр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╕лр╕Щр╕▓р╣Бр╕Щр╣Ир╕Щр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф")
        date_summary = df.groupby('р╕зр╕▒р╕Щр╕Чр╕╡р╣И').size().reset_index(name='р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г')
        date_summary = date_summary.sort_values(by='р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕▓р╕вр╕Бр╕▓р╕г', ascending=False)
        st.dataframe(date_summary, use_container_width=True)

# --- р╕лр╕Щр╣Йр╕▓р╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ ---
elif page == "ЁЯУж р╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н":
    st.title("ЁЯУж р╕гр╕░р╕Ър╕Ър╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕Хр╣Зр╕нр╕Б (р╕Кр╕╡р╕Х: р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н)")
    df_stock = get_data("р╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓", "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н")

    if not df_stock.empty:
        df_stock.columns = [c.strip() for c in df_stock.columns]
        
        # 1. р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╣Ар╕лр╕ер╕╖р╕нр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓ 2
        st.subheader("тЪая╕П р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Бр╕ер╣Йр╕лр╕бр╕Ф (р╣Ар╕лр╕ер╕╖р╕нр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓ 2)")
        # р╕кр╕бр╕бр╕Хр╕┤р╕зр╣Ир╕▓р╕Кр╕╖р╣Ир╕нр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Др╕╖р╕н 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н' р╕лр╕гр╕╖р╕н 'р╕Ир╕│р╕Щр╕зр╕Щр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н'
        col_name = 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н' if 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н' in df_stock.columns else df_stock.columns[-1]
        low_stock = df_stock[df_stock[col_name] < 2]
        
        if not low_stock.empty:
            st.warning(f"р╕Юр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓ {len(low_stock)} р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Хр╕┤р╕бр╕Фр╣Ир╕зр╕Щ!")
            st.dataframe(low_stock, use_container_width=True)
        else:
            st.success("р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Ар╕Хр╕┤р╕б (р╣Ар╕лр╕ер╕╖р╕нр╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 2 р╕Чр╕╕р╕Бр╕гр╕▓р╕вр╕Бр╕▓р╕г)")

        st.divider()

        # 2. р╕Хр╕▓р╕гр╕▓р╕Зр╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
        st.subheader("ЁЯУЛ р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕кр╕Хр╣Зр╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф")
        st.dataframe(df_stock, use_container_width=True)
